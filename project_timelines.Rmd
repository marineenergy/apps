---
title: "project_timelines"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Fetch Data

Using [MHK Project Timeline Input - Google Sheets](https://docs.google.com/spreadsheets/d/1HC5hXyi2RQSHevnV7rvyk748U5-X3iUw70ewHEfrHm0/edit#gid=793817660)

```{r}
library(dplyr)
library(htmltools)
library(htmlwidgets)

csv_key <- "1HC5hXyi2RQSHevnV7rvyk748U5-X3iUw70ewHEfrHm0"
csv_url <- glue::glue("https://docs.google.com/spreadsheets/d/{csv_key}/gviz/tq?tqx=out:csv&sheet=0")

d <- readr::read_csv(csv_url) %>% 
  select(-starts_with("X"))

d_times <- d %>% 
  filter(!is.na(date_beg))

d_permits <- d %>% 
  filter(!is.na(permit_type)) %>% 
  select(project_name, permit_type, license_date, permit_doc_link) %>% 
  mutate(
    license_date = as.Date(license_date, format = "%m/%d/%Y")) %>% 
  arrange(project_name, license_date)
#d_permits

# View(d_times)
# View(d_permits)

library(ggplot2)
library(plotly)

g <- ggplot(
  d_permits, 
  aes(
    x = license_date, 
    y = project_name,
    color = factor(permit_type))) + 
  geom_point(shape = 17)

# static
g

# interactive
ggplotly(g)
  

js <- HTML(paste("var myPlot = document.getElementById('PlotlyGraph');
myPlot.on('plotly_click', function(data){
var urls = ['", paste(d_permits$permit_doc_link, collapse = "', '"), "'];
window.open(urls[data.points[0].pointNumber],'_blank');
});", sep=''))

# clickable

p <- plotly_build(g)
p$elementId <- "PlotlyGraph"

tagList(
  #ggplotly(g),
  p,
  onStaticRenderComplete(js))
```


